<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width,initial-scale=1" />
        <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
        <meta http-equiv="Pragma" content="no-cache" />
        <meta http-equiv="Expires" content="0" />
        <link rel="icon" type="image/png" href="favicon.png" />
        <link rel="stylesheet" href="dev.css" />

        <title>Slidy 3.0 - NativeJS</title>

        <script defer src="dev.js"></script>
    </head>

    <body>
        <header>
            <img alt="Slidy" width="50" height="50" src="favicon.png" />
            <h1>
                Slidy 3.0<sub>nativeJS</sub>
                <sup id="stats" />
            </h1>
            <button id="dark" onclick="activate(this, dark)">dark</button>
        </header>
        <main style="--gap: 1em; --flow: row; --width: auto; --height: 350px">
            <section tabindex="0">
                <ul id="slidy">
                    <li style="display: grid; place-items: center">Loading...</li>
                </ul>
            </section>
        </main>
        <footer>
            <nav id="buttons">
                <button id="clamp" onclick="slidy.update({clamp: activate(this, options.clamp)})">clamp</button>
                <button id="snap" onclick="slidy.update({snap: activate(this, options.snap)})">snap</button>
                <button id="loop" onclick="slidy.update({loop: activate(this, options.loop)})">loop</button>
                <button id="vertical" onclick="slidy.update({vertical: activate(this, options.vertical)})">
                    vertical
                </button>
            </nav>

            <nav>
                <button id="prev" onclick="slidy.to(options.index - 1)">←</button>
                <button id="reload" onclick="getPhotos(node, randomQ(1, 69), limit)">
                    <i class="icon icon-refresh"></i>
                </button>
                <button id="next" onclick="slidy.to(options.index + 1)">→</button>
            </nav>

            <nav id="dots"></nav>

            <form>
                <fieldset>
                    <label title="limit">
                        <input onchange="setLimit()" name="limit" type="number" size="1" step="1" min="1" max="100" />
                    </label>
                    <label title="width">
                        <input onchange="setVar(main, this.name, this.value)" name="width" size="5" />
                    </label>
                    <label title="height">
                        <input onchange="setVar(main, this.name, this.value)" name="height" size="5" />
                    </label>
                    <label title="gap">
                        <input onchange="setVar(main, this.name, this.value)" name="gap" size="3" />
                    </label>
                    <label title="duration">
                        <input
                            onchange="changeValue()"
                            name="duration"
                            type="number"
                            size="4"
                            step="1"
                            min="100"
                            max="1000"
                        />
                    </label>
                    <label title="gravity">
                        <input
                            onchange="changeValue()"
                            name="gravity"
                            type="number"
                            size="4"
                            step="0.1"
                            min="0.1"
                            max="2"
                        />
                    </label>
                    <!-- <label>
                align
                <select bind:value={align}>
                    <option value="start">← start</option>
                    <option value="middle">middle</option>
                    <option value="end">end →</option>
                </select>
            </label> -->
                </fieldset>
            </form>
        </footer>

        <article>
            <h1>HTML Ipsum Presents</h1>

            <p>
                <strong>Pellentesque habitant morbi tristique</strong> senectus et netus et malesuada fames ac turpis
                egestas. Vestibulum tortor quam, feugiat vitae, ultricies eget, tempor sit amet, ante. Donec eu libero
                sit amet quam egestas semper. <em>Aenean ultricies mi vitae est.</em> Mauris placerat eleifend leo.
                Quisque sit amet est et sapien ullamcorper pharetra. Vestibulum erat wisi, condimentum sed,
                <code>commodo vitae</code>, ornare sit amet, wisi. Aenean fermentum, elit eget tincidunt condimentum,
                eros ipsum rutrum orci, sagittis tempus lacus enim ac dui. <a href="#">Donec non enim</a> in turpis
                pulvinar facilisis. Ut felis.
            </p>

            <h2>Header Level 2</h2>

            <ol>
                <li>Lorem ipsum dolor sit amet, consectetuer adipiscing elit.</li>
                <li>Aliquam tincidunt mauris eu risus.</li>
            </ol>

            <blockquote>
                <p>
                    Lorem ipsum dolor sit amet, consectetur adipiscing elit. Vivamus magna. Cras in mi at felis aliquet
                    congue. Ut a est eget ligula molestie gravida. Curabitur massa. Donec eleifend, libero at sagittis
                    mollis, tellus est malesuada tellus, at luctus turpis elit sit amet quam. Vivamus pretium ornare
                    est.
                </p>
            </blockquote>

            <h3>Header Level 3</h3>

            <ul>
                <li>Lorem ipsum dolor sit amet, consectetuer adipiscing elit.</li>
                <li>Aliquam tincidunt mauris eu risus.</li>
            </ul>

            <pre><code>
            #header h1 a {
              display: block;
              width: 300px;
              height: 80px;
            }
            </code></pre>
        </article>

        <script>
            let position = 0,
                slidy = null,
                dark = window.matchMedia('(prefers-color-scheme: dark)').matches,
                page = randomQ(1, 69),
                limit = 16;

            let options = {
                index: 8,
                length: limit,
                snap: true,
                loop: false,
                clamp: false,
                gravity: 1.2,
                duration: 375,
                vertical: false,
            };

            const main = document.querySelector('main'),
                node = document.querySelector('#slidy'),
                nav = document.querySelector('#dots'),
                stats = document.querySelector('#stats'),
                buttons = document.querySelectorAll('button'),
                inputs = document.querySelectorAll('input');

            window.onload = () => {
                getPhotos(node, page, limit);

                for (const button of buttons) {
                    if (options[button.id] || (button.id === 'dark' && dark)) button.classList.add('active');
                }
                for (const input of inputs) {
                    if (input.name in options) input.value = options[input.name];
                    else if (input.name === 'width') input.value = getVar(main, '--width');
                    else if (input.name === 'height') input.value = getVar(main, '--height');
                    else if (input.name === 'gap') input.value = getVar(main, '--gap');
                    else if (input.name === 'limit') input.value = limit;
                }

                node.addEventListener('mount', (e) => {
                    // console.log(e, options, buttons, inputs);
                });

                node.addEventListener('move', (e) => {
                    indexing(e.detail.index);
                    scrolling(e.detail.position);
                });

                node.addEventListener('resize', (e) => {
                    // console.log(e)
                });

                node.addEventListener('update', (e) => {
                    // console.log(e)
                });

                function scrolling(p) {
                    position = p;
                    stats.innerHTML = `[<b>${options.index}</b>] / <b>${Math.trunc(position)}</b>px`;
                }

                function indexing(x) {
                    options.index = x;
                    const cix = Math.floor(node.children.length / 2);

                    Array.from(node.children).forEach((n, i) =>
                        i === (options.loop ? cix : x) ? n.classList.add('active') : n.classList.remove('active')
                    );
                    Array.from(nav.children).forEach((n, i) =>
                        i === x ? n.classList.add('active') : n.classList.remove('active')
                    );
                }
            };

            function activate(node, prop) {
                node.classList.toggle('active');
                switch (event.target.id) {
                    case 'dark':
                        document.documentElement.setAttribute('scheme', !dark ? 'dark' : 'light');
                        dark = !dark;
                        break;
                    case 'vertical':
                        setVar(main, 'flow', vertical ? 'column' : 'row');
                        vertical = !vertical;
                        break;

                    default:
                        break;
                }
                prop = !prop;
                return prop;
            }

            function changeValue() {
                slidy.update({ [event.target.name]: +event.target.value });
                options[event.target.name] = +event.target.value;
            }
            function getVar(node, name) {
                return getComputedStyle(node).getPropertyValue(name);
            }
            function setVar(node, name, value) {
                return node.style.setProperty(`--${name}`, value);
            }

            function setLimit() {
                options.length = limit = event.target.value;
                // slidy.update({ length: options.length })
                getPhotos(node, page, limit);
            }

            async function getPhotos(node, page, limit) {
                node.innerHTML = `<li style="display: grid; place-items: center">Loading...</li>`;

                fetch(`https://picsum.photos/v2/list?limit=${limit}&page=${page}`)
                    .then(async (res) => {
                        const photos = await res.json();
                        console.log(photos, window.outerWidth, window.outerHeight);
                        if (photos.length) {
                            node.innerHTML = photos
                                .map((p, i) => {
                                    const aspect = aspectQ(p.width, p.height, main.offsetWidth, main.offsetHeight);
                                    return `<li id="${i}"><img src="https://picsum.photos/id/${p.id}/${
                                        aspect.width * window.devicePixelRatio
                                    }/${aspect.height * window.devicePixelRatio}.jpg" width="${aspect.width}" height="${
                                        aspect.height
                                    }" alt="${p.author}"/></li>`;
                                })
                                .join('');
                            nav.innerHTML = photos
                                .map((p, i) => `<button onclick="slidy.to(${i})">${i}</button>`)
                                .join('');
                        } else {
                            slidy?.to(0);
                            node.innerHTML = `<li style="display: grid; place-items: center">Slidy haven't items 🤷🏻‍♂️</li>`;
                        }
                    })
                    .then(() => {
                        console.log('destroy');
                        slidy?.destroy();
                        slidy = Slidy.slidy(node, options);
                    })
                    .catch((error) => {
                        console.error(error);
                    });
            }

            function aspectQ(srcWidth, srcHeight, maxWidth, maxHeight) {
                let ratio = Math.min(maxWidth / srcWidth, maxHeight / srcHeight);
                return {
                    width: Math.round(srcWidth * ratio),
                    height: Math.round(srcHeight * ratio),
                };
            }

            function randomQ(min, max) {
                return Math.floor(Math.random() * (max - min + 1)) + min;
            }
        </script>
    </body>
</html>
